# WebSocket Opus音频播放实现说明

## 实现概述

已成功修改 `xz_main.c` 中的 `websockets_callback` 函数，实现了接收WebSocket音频流并通过杰理AC7916开发板播放的功能。

## 核心修改

### 1. 添加的文件

- **opus_decoder_wrapper.h** - Opus解码器接口定义
- **opus_decoder_wrapper.c** - Opus解码器实现
- **OPUS_AUDIO_PLAYBACK_README.md** - 详细使用文档
- **Makefile_opus_integration.txt** - Makefile修改指南

### 2. 修改的文件

- **xz_main.c** - 主要修改内容

## 主要功能

### websockets_callback 函数处理逻辑

```
收到WebSocket消息
    ↓
判断消息类型 (type值)
    ↓
├─ type = 129 (0x81) → JSON文本消息
│   ├─ 解析JSON消息
│   ├─ 处理Hello/STT/TTS/Listen消息
│   └─ TTS开始时初始化音频播放器
│
└─ type = 130 (0x82) → Opus二进制音频数据
    ├─ 检查音频播放器状态
    ├─ 如未初始化则初始化
    ├─ 使用Opus解码器解码数据
    ├─ 将PCM数据写入播放器
    └─ 通过DAC播放音频
```

## 关键代码说明

### 1. 音频参数配置

```c
#define OPUS_SAMPLE_RATE    16000  // 采样率16kHz
#define OPUS_CHANNELS       1      // 单声道
#define OPUS_FRAME_DURATION 60     // 60ms帧时长
#define OPUS_FRAME_SIZE     960    // 每帧960个采样点
```

### 2. 音频播放器初始化

```c
audio_player_init()
    ├─ 初始化Opus解码器 (opus_decoder_wrapper_init)
    └─ 初始化PCM播放器 (audio_pcm_play_open)
        ├─ 采样率: 16000Hz
        ├─ 声道数: 1
        ├─ 音量: 80 (0-100)
        └─ 非阻塞模式
```

### 3. Opus数据处理流程

```c
接收Opus数据 (type=130)
    ↓
opus_decoder_wrapper_decode()  // 解码Opus → PCM
    ↓
audio_play_pcm_data()          // 播放PCM数据
    ↓
audio_pcm_play_data_write()    // 写入音频硬件
    ↓
DAC输出音频
```

## 使用方法

### 快速开始（需要集成libopus）

#### 步骤1: 修改opus_decoder_wrapper.c

取消注释以下行以使用标准libopus库：
```c
#define USE_LIBOPUS
```

#### 步骤2: 添加libopus库

1. 获取适用于AC7916的libopus库文件
2. 将 `opus.h` 等头文件放到 include 目录
3. 将 `libopus.a` 放到 lib 目录

#### 步骤3: 修改Makefile

参考 `Makefile_opus_integration.txt` 文件修改Makefile

#### 步骤4: 编译和烧录

```bash
make clean
make
# 使用杰理烧录工具烧录固件
```

### 替代方案（无需外部库）

如果暂时无法集成libopus，可以：

1. **使用SDK内置的opus解码器**
   - 链接 `cpu/wl82/liba/lib_opus_dec.a`
   - 需要更复杂的audio_server配置

2. **修改服务器发送PCM数据**
   - 服务器端将Opus解码为PCM后再发送
   - 客户端直接播放PCM数据（注释掉解码步骤）

## 调试和验证

### 查看调试输出

通过串口查看以下调试信息：

```
wbs recv type: 130, len: xxx          // 收到Opus数据
Audio player initialized successfully  // 播放器初始化成功
Opus decoder initialized              // Opus解码器初始化
Played PCM data: 960 samples          // PCM数据播放成功
```

### 常见问题排查

| 问题 | 可能原因 | 解决方法 |
|------|---------|---------|
| 没有声音 | Opus解码器未正确初始化 | 检查USE_LIBOPUS定义和libopus库 |
| 播放卡顿 | 网络延迟或缓冲区太小 | 增大PCM缓冲区 |
| 解码失败 | Opus数据格式不匹配 | 确认服务器端参数配置 |
| 编译错误 | 缺少libopus库 | 添加libopus库文件和头文件 |

## 技术细节

### Opus音频参数说明

根据协议定义，客户端和服务端的Opus格式细节：

```json
{
  "format": "opus",
  "sample_rate": 16000,
  "channels": 1,
  "frame_duration": 60
}
```

- **采样率**: 16000 Hz (16kHz)
- **声道数**: 1 (单声道)
- **帧时长**: 60 ms
- **每帧采样点**: 16000 × 0.06 = 960 samples
- **每帧PCM数据**: 960 × 2 bytes × 1 channel = 1920 bytes

### WebSocket帧类型

- **0x81** (129): FIN=1, Opcode=1 (文本帧) → JSON消息
- **0x82** (130): FIN=1, Opcode=2 (二进制帧) → Opus音频数据

## 性能和资源占用

- **RAM使用**: 约8KB (PCM缓冲区 + Opus解码器状态)
- **CPU占用**: 取决于Opus解码器优化程度
- **延迟**: 约60-120ms (一到两个音频帧)

## 后续优化建议

1. **实现双缓冲机制** - 减少播放卡顿
2. **添加音频同步** - 处理网络抖动
3. **错误恢复机制** - 解码失败时的处理
4. **动态音量控制** - 根据环境调节音量
5. **支持更多格式** - AAC、MP3等

## 参考资料

- `OPUS_AUDIO_PLAYBACK_README.md` - 详细技术文档
- `Makefile_opus_integration.txt` - Makefile配置指南
- AC79xx音频服务使用开发文档.pdf - SDK音频服务文档
- https://opus-codec.org/ - Opus官方网站

## 联系和支持

如有技术问题，请参考：
1. 杰理AC7916开发者社区
2. 项目代码中的注释说明
3. SDK配套的技术文档

---

**版本**: v1.0  
**日期**: 2025-10-30  
**作者**: AI Assistant

