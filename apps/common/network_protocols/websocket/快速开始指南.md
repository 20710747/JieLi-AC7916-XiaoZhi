# ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—

## å·²å®Œæˆçš„ä¿®æ”¹

âœ… ä¿®æ”¹äº† `xz_main.c` - å®ç°WebSocketéŸ³é¢‘æ¥æ”¶å’Œæ’­æ”¾  
âœ… åˆ›å»ºäº† `opus_decoder_wrapper.h` - Opusè§£ç å™¨æ¥å£  
âœ… åˆ›å»ºäº† `opus_decoder_wrapper.c` - Opusè§£ç å™¨å®ç°  
âœ… åˆ›å»ºäº†å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£

## æ ¸å¿ƒåŠŸèƒ½

```
WebSocketæ¥æ”¶ â†’ åˆ¤æ–­æ¶ˆæ¯ç±»å‹
    â†“
type=129 (JSON) â†’ å¤„ç†æ§åˆ¶æ¶ˆæ¯ï¼ˆTTSå¼€å§‹/ç»“æŸç­‰ï¼‰
type=130 (äºŒè¿›åˆ¶) â†’ OpuséŸ³é¢‘æ•°æ® â†’ è§£ç  â†’ æ’­æ”¾
```

## ç«‹å³ä½¿ç”¨ï¼ˆ3æ­¥ï¼‰

### ç¬¬1æ­¥ï¼šé›†æˆlibopusåº“

**é€‰æ‹©Aï¼šä½¿ç”¨æ ‡å‡†libopusï¼ˆæ¨èï¼‰**
```c
// åœ¨ opus_decoder_wrapper.c é¡¶éƒ¨å–æ¶ˆæ³¨é‡Šï¼š
#define USE_LIBOPUS
```
ç„¶åæ·»åŠ libopusçš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶åˆ°é¡¹ç›®ä¸­ã€‚

**é€‰æ‹©Bï¼šä½¿ç”¨SDKå†…ç½®opusåº“**
```makefile
# åœ¨Makefileä¸­æ·»åŠ ï¼š
LIBS += $(src)/cpu/wl82/liba/lib_opus_dec.a
```

### ç¬¬2æ­¥ï¼šä¿®æ”¹Makefile

å‚è€ƒ `Makefile_opus_integration.txt` æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```makefile
# æ·»åŠ æºæ–‡ä»¶
objs += \
    websocket/xz_main.o \
    websocket/opus_decoder_wrapper.o

# æ·»åŠ å¤´æ–‡ä»¶è·¯å¾„
INCLUDES += \
    -I$(src)/apps/common/audio_music \
    -I$(src)/include_lib/server
```

### ç¬¬3æ­¥ï¼šç¼–è¯‘å’Œæµ‹è¯•

```bash
make clean
make
# çƒ§å½•å›ºä»¶åˆ°å¼€å‘æ¿
# æŸ¥çœ‹ä¸²å£è¾“å‡ºéªŒè¯åŠŸèƒ½
```

## éªŒè¯å·¥ä½œæ­£å¸¸

ä¸²å£ä¼šè¾“å‡ºï¼š
```
âœ“ Audio player initialized successfully
âœ“ Opus decoder initialized
âœ“ Received Opus audio data, len: xxx
âœ“ Played PCM data: 960 samples, 1920 bytes
```

## ä¸´æ—¶æµ‹è¯•æ–¹æ¡ˆï¼ˆæ— éœ€libopusï¼‰

å¦‚æœæš‚æ—¶æ— æ³•é›†æˆopusè§£ç å™¨ï¼Œå¯ä»¥è®©æœåŠ¡å™¨ç›´æ¥å‘é€PCMæ•°æ®ï¼š

åœ¨ `xz_main.c` ç¬¬183è¡Œçš„ `else if (type == 130)` éƒ¨åˆ†ï¼Œæ›¿æ¢ä¸ºï¼š
```c
else if (type == 130) {
    // å‡è®¾æœåŠ¡å™¨å‘é€çš„æ˜¯PCMæ•°æ®
    if (!g_audio_playing) {
        audio_player_init();
    }
    audio_play_pcm_data(buf, len);  // ç›´æ¥æ’­æ”¾
}
```

## é…ç½®å‚æ•°

åœ¨ `xz_main.c` ä¸­å¯è°ƒæ•´çš„å‚æ•°ï¼š

```c
#define OPUS_SAMPLE_RATE 16000  // é‡‡æ ·ç‡
#define OPUS_CHANNELS 1         // å£°é“æ•°
#define OPUS_FRAME_DURATION 60  // å¸§æ—¶é•¿(ms)

// audio_player_init() å‡½æ•°ä¸­ï¼š
80,  // éŸ³é‡ (0-100)
```

## å¸¸è§é—®é¢˜é€ŸæŸ¥

| é—®é¢˜ | è§£å†³ |
|-----|-----|
| ç¼–è¯‘é”™è¯¯: opus_* æœªå®šä¹‰ | æ·»åŠ libopusåº“æ–‡ä»¶ |
| æ²¡æœ‰å£°éŸ³ | æ£€æŸ¥éŸ³é‡è®¾ç½®å’ŒDACé…ç½® |
| æ’­æ”¾å¡é¡¿ | å¢å¤§ PCM_BUFFER_SIZE |

## è¯¦ç»†æ–‡æ¡£

ğŸ“– **å®Œæ•´æŠ€æœ¯æ–‡æ¡£**: `OPUS_AUDIO_PLAYBACK_README.md`  
ğŸ“– **ä¸­æ–‡è¯´æ˜**: `å®ç°è¯´æ˜_ç®€ä½“ä¸­æ–‡.md`  
ğŸ“– **ä¿®æ”¹æ€»ç»“**: `ä¿®æ”¹æ€»ç»“.md`  
ğŸ“– **Makefileé…ç½®**: `Makefile_opus_integration.txt`

## æŠ€æœ¯æ”¯æŒ

ä»£ç ä¸­åŒ…å«è¯¦ç»†çš„æ³¨é‡Šå’Œè°ƒè¯•è¾“å‡ºï¼Œæœ‰é—®é¢˜è¯·æŸ¥çœ‹ä¸²å£æ—¥å¿—ã€‚

---
**çŠ¶æ€**: âœ… å®ç°å®Œæˆ  
**ç‰ˆæœ¬**: v1.0  
**æ—¥æœŸ**: 2025-10-30

